/*
 * Copyright 2002-2018 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.webauthn4j.extras.fido.metadata.statement;

import com.webauthn4j.extras.fido.metadata.FIDOMDSClient;
import com.webauthn4j.registry.Registry;
import org.junit.Before;
import org.junit.Test;

import java.time.OffsetDateTime;
import java.time.ZoneOffset;
import java.util.HashMap;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

public class FIDOMDSMetadataStatementProviderTest {

    private FIDOMDSClient fidoMDSClient = mock(FIDOMDSClient.class);
    private FIDOMDSMetadataStatementProvider target = new FIDOMDSMetadataStatementProvider(new Registry(), fidoMDSClient);
    private OffsetDateTime now = OffsetDateTime.now(ZoneOffset.UTC);

    @Before
    public void setup(){
        String toc = "eyJhbGciOiAiRVMyNTYiLCAidHlwIjogIkpXVCIsICJ4NWMiOiBbIk1JSUNuRENDQWtLZ0F3SUJBZ0lOQWV3Y2pYMHludXpIendKd2F6QUtCZ2dxaGtqT1BRUURBakJUTVFzd0NRWURWUVFHRXdKVlV6RVdNQlFHQTFVRUNoTU5Sa2xFVHlCQmJHeHBZVzVqWlRFZE1Cc0dBMVVFQ3hNVVRXVjBZV1JoZEdFZ1ZFOURJRk5wWjI1cGJtY3hEVEFMQmdOVkJBTVRCRU5CTFRFd0hoY05NVGd3TkRFNE1EQXdNREF3V2hjTk1qRXdOREU0TURBd01EQXdXakJrTVFzd0NRWURWUVFHRXdKVlV6RVdNQlFHQTFVRUNoTU5Sa2xFVHlCQmJHeHBZVzVqWlRFZE1Cc0dBMVVFQ3hNVVRXVjBZV1JoZEdFZ1ZFOURJRk5wWjI1cGJtY3hIakFjQmdOVkJBTVRGVTFsZEdGa1lYUmhJRlJQUXlCVGFXZHVaWElnTXpCWk1CTUdCeXFHU000OUFnRUdDQ3FHU000OUF3RUhBMElBQklwZjZuZGJhUFVaWGlWRENmc2RjMlBpV0gxN2JBQnJvbjIwRWhDRnRCT1NveTgxa2FjZkU2ZnZKTm5jMmxnN2xrWldDdjljTHJxcVdMc0ZZRHlPQk4ramdla3dnZVl3RGdZRFZSMFBBUUgvQkFRREFnYkFNQXdHQTFVZEV3RUIvd1FDTUFBd0hRWURWUjBPQkJZRUZGeVEwWDdQUEV5NHUrYjZwR010NGxCL1FQRExNQjhHQTFVZEl3UVlNQmFBRkdrUlhpMXBaSVdkbHJqVy8xek52engxejB3WU1EVUdBMVVkSHdRdU1Dd3dLcUFvb0NhR0pHaDBkSEE2THk5dFpITXVabWxrYjJGc2JHbGhibU5sTG05eVp5OURRUzB4TG1OeWJEQlBCZ05WSFNBRVNEQkdNRVFHQ3lzR0FRUUJndVVjQVFNQk1EVXdNd1lJS3dZQkJRVUhBZ0VXSjJoMGRIQnpPaTh2YldSekxtWnBaRzloYkd4cFlXNWpaUzV2Y21jdmNtVndiM05wZEc5eWVUQUtCZ2dxaGtqT1BRUURBZ05JQURCRkFpRUFsRzI2cU9PTHUzcGt5Q1RoQUV4eEpwTDZsL1YvVVlReStHRGNRMk10Y3EwQ0lHUllHYUZWbThFbmdhOGE5TGUzQ2lMcCt0YzJOM09jR21QQk9VeTdwSTZ0IiwgIk1JSUNzakNDQWppZ0F3SUJBZ0lPUnFteGs4TlF1SmZDRU5WWWExUXdDZ1lJS29aSXpqMEVBd013VXpFTE1Ba0dBMVVFQmhNQ1ZWTXhGakFVQmdOVkJBb1REVVpKUkU4Z1FXeHNhV0Z1WTJVeEhUQWJCZ05WQkFzVEZFMWxkR0ZrWVhSaElGUlBReUJUYVdkdWFXNW5NUTB3Q3dZRFZRUURFd1JTYjI5ME1CNFhEVEUxTURZeE56QXdNREF3TUZvWERUUXdNRFl4TnpBd01EQXdNRm93VXpFTE1Ba0dBMVVFQmhNQ1ZWTXhGakFVQmdOVkJBb1REVVpKUkU4Z1FXeHNhV0Z1WTJVeEhUQWJCZ05WQkFzVEZFMWxkR0ZrWVhSaElGUlBReUJUYVdkdWFXNW5NUTB3Q3dZRFZRUURFd1JEUVMweE1Ga3dFd1lIS29aSXpqMENBUVlJS29aSXpqMERBUWNEUWdBRTlzRGdDOFB6QllsL3dLcXBYZmE5OGpPSW83OGw5cHo0eE96R0RHSXowekVYTVhzQlk2a0FoeVU0R1JtVDB3bzR0eVV2eDVCWThPS2xzTE16bGJLTVJhT0I3ekNCN0RBT0JnTlZIUThCQWY4RUJBTUNBUVl3RWdZRFZSMFRBUUgvQkFnd0JnRUIvd0lCQURBZEJnTlZIUTRFRmdRVWFSRmVMV2xraFoyV3VOYi9YTTIvUEhYUFRCZ3dId1lEVlIwakJCZ3dGb0FVMHFVZkM2ZjJZc2hBMU5pOXVkZU8wVlM3dkVZd05RWURWUjBmQkM0d0xEQXFvQ2lnSm9Za2FIUjBjRG92TDIxa2N5NW1hV1J2WVd4c2FXRnVZMlV1YjNKbkwxSnZiM1F1WTNKc01FOEdBMVVkSUFSSU1FWXdSQVlMS3dZQkJBR0M1UndCQXdFd05UQXpCZ2dyQmdFRkJRY0NBUlluYUhSMGNITTZMeTl0WkhNdVptbGtiMkZzYkdsaGJtTmxMbTl5Wnk5eVpYQnZjMmwwYjNKNU1Bb0dDQ3FHU000OUJBTURBMmdBTUdVQ01CTFZxMEpkV3YyeVk0UnAxSWl5SVZXRUtHMVBUejFwUEFGcUVuYWtQdHc0Uk1SVEd3SGRiMmlmY0RiUG9Fa2ZZUUl4QU9Ma2ZFUGoyMmZCbmVqMXd0Z3l5bHN1NzNyS0xVdjR4aER5OVRBZVZVbWwwaURCTThTdEU0RGlWcy80ZWpGaHFRPT0iXX0.eyJuZXh0VXBkYXRlIjogIjIwMTktMDItMDYiLCAiZW50cmllcyI6IFt7InVybCI6ICJodHRwczovL21kczIuZmlkb2FsbGlhbmNlLm9yZy9tZXRhZGF0YS8wMDFEJTIzMDAwMiIsICJ0aW1lT2ZMYXN0U3RhdHVzQ2hhbmdlIjogIjIwMTgtMDctMTgiLCAiaGFzaCI6ICJ5X0UzdW5jN0JLOV9XeVVXUUdvUHdOVmtCcDNSa3ZaNUhKMkRJTDRXcV9JPSIsICJhYWlkIjogIjAwMUQjMDAwMiIsICJzdGF0dXNSZXBvcnRzIjogW3sic3RhdHVzIjogIkZJRE9fQ0VSVElGSUVEX0wxIiwgImNlcnRpZmljYXRlTnVtYmVyIjogIlVBRjEwMDAyMDE4MDIyMTAwMyIsICJjZXJ0aWZpY2F0ZSI6ICIiLCAiY2VydGlmaWNhdGlvbkRlc2NyaXB0b3IiOiAiRklETyBVQUYgVFYgUmVtb3RlIiwgInVybCI6ICJ3d3cuY2VsZHR2LmNvbSIsICJjZXJ0aWZpY2F0aW9uUmVxdWlyZW1lbnRzVmVyc2lvbiI6ICIxLjEuMCIsICJjZXJ0aWZpY2F0aW9uUG9saWN5VmVyc2lvbiI6ICIxLjAuMSIsICJlZmZlY3RpdmVEYXRlIjogIjIwMTgtMDctMTgifV19LCB7InVybCI6ICJodHRwczovL21kczIuZmlkb2FsbGlhbmNlLm9yZy9tZXRhZGF0YS8wMDQyJTIzMDAwMiIsICJ0aW1lT2ZMYXN0U3RhdHVzQ2hhbmdlIjogIjIwMTgtMDktMTMiLCAiaGFzaCI6ICJwa2ZBbVRPbG5DaWF6bHY1cVNvTnlYaEtBM2FaeGVUUHNHSDVJS2dQTHRjPSIsICJhYWlkIjogIjAwNDIjMDAwMiIsICJzdGF0dXNSZXBvcnRzIjogW3sic3RhdHVzIjogIkZJRE9fQ0VSVElGSUVEIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGUiOiAiIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0wOS0xMyJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzAwNTIlMjMwMDAxIiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0wOC0wMSIsICJoYXNoIjogInV3SlVSVWYyckNpS0J6bGRJcTZOMF9KVVV2UWhha19ObjlMcFJSY1Q4RXc9IiwgImFhaWQiOiAiMDA1MiMwMDAxIiwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiRklET19DRVJUSUZJRURfTDEiLCAiY2VydGlmaWNhdGVOdW1iZXIiOiAiVUFGMTAwMDIwMTgwMjIxMDA0IiwgImNlcnRpZmljYXRlIjogIiIsICJjZXJ0aWZpY2F0aW9uRGVzY3JpcHRvciI6ICJGSURPIEwxIENsaWVudC9BdXRoZW50aWNhdG9yIENvbWJvIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGlvblJlcXVpcmVtZW50c1ZlcnNpb24iOiAiMS4wLjAiLCAiY2VydGlmaWNhdGlvblBvbGljeVZlcnNpb24iOiAiMS4zLjIiLCAiZWZmZWN0aXZlRGF0ZSI6ICIyMDE4LTA4LTAxIn1dfSwgeyJ1cmwiOiAiaHR0cHM6Ly9tZHMyLmZpZG9hbGxpYW5jZS5vcmcvbWV0YWRhdGEvMDA1MiUyMzAwMDIiLCAidGltZU9mTGFzdFN0YXR1c0NoYW5nZSI6ICIyMDE4LTA4LTAxIiwgImhhc2giOiAiZkxTalgwTjJHZGoxNkVyWXVhTEVUeWdDYTZxUmswUkFCa0NPV3VVZEZJdz0iLCAiYWFpZCI6ICIwMDUyIzAwMDIiLCAic3RhdHVzUmVwb3J0cyI6IFt7InN0YXR1cyI6ICJGSURPX0NFUlRJRklFRF9MMSIsICJjZXJ0aWZpY2F0ZU51bWJlciI6ICJVQUYxMDAwMjAxODAyMjEwMDEiLCAiY2VydGlmaWNhdGUiOiAiIiwgImNlcnRpZmljYXRpb25EZXNjcmlwdG9yIjogIkZJRE8gTDEgQ2xpZW50L0F1dGhlbnRpY2F0b3IgQ29tYm8iLCAidXJsIjogIiIsICJjZXJ0aWZpY2F0aW9uUmVxdWlyZW1lbnRzVmVyc2lvbiI6ICIxLjAuMCIsICJjZXJ0aWZpY2F0aW9uUG9saWN5VmVyc2lvbiI6ICIxLjMuMiIsICJlZmZlY3RpdmVEYXRlIjogIjIwMTgtMDgtMDEifV19LCB7InVybCI6ICJodHRwczovL21kczIuZmlkb2FsbGlhbmNlLm9yZy9tZXRhZGF0YS8wMDU2JTIzMDAwMiIsICJ0aW1lT2ZMYXN0U3RhdHVzQ2hhbmdlIjogIjIwMTgtMDgtMzAiLCAiaGFzaCI6ICJjMjlGSlJ0REdLWEJGVFVBUEJMdU9ESlJwQUMyak1nUjNZMDJQMjktSmk0PSIsICJhYWlkIjogIjAwNTYjMDAwMiIsICJzdGF0dXNSZXBvcnRzIjogW3sic3RhdHVzIjogIkZJRE9fQ0VSVElGSUVEX0wxIiwgImNlcnRpZmljYXRlTnVtYmVyIjogIlVBRjExMDAyMDE4MDUxMTAwMSIsICJjZXJ0aWZpY2F0ZSI6ICIiLCAiY2VydGlmaWNhdGlvbkRlc2NyaXB0b3IiOiAiUGl4ZWxQaW4gaU9TIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGlvblJlcXVpcmVtZW50c1ZlcnNpb24iOiAiMS4xLjAiLCAiY2VydGlmaWNhdGlvblBvbGljeVZlcnNpb24iOiAiMS4wLjEiLCAiZWZmZWN0aXZlRGF0ZSI6ICIyMDE4LTA4LTMwIn1dfSwgeyJ1cmwiOiAiaHR0cHM6Ly9tZHMyLmZpZG9hbGxpYW5jZS5vcmcvbWV0YWRhdGEvMDA2MyUyMzAwMDIiLCAidGltZU9mTGFzdFN0YXR1c0NoYW5nZSI6ICIyMDE4LTA2LTEyIiwgImhhc2giOiAiR1Z6SlhydUJYMUdwYVJkZnBmUHlmazBEb3BxM25yVDNHRktwZENJa1hCWT0iLCAiYWFpZCI6ICIwMDYzIzAwMDIiLCAic3RhdHVzUmVwb3J0cyI6IFt7InN0YXR1cyI6ICJOT1RfRklET19DRVJUSUZJRUQiLCAiY2VydGlmaWNhdGUiOiAiIiwgImNlcnRpZmljYXRpb25EZXNjcmlwdG9yIjogIlNUSUQgRklETyBBVVRIRU5USUNBVE9SIElPUyAwMDYzIzAwMDIiLCAidXJsIjogIiIsICJjZXJ0aWZpY2F0aW9uUmVxdWlyZW1lbnRzVmVyc2lvbiI6ICIxLjAiLCAiY2VydGlmaWNhdGlvblBvbGljeVZlcnNpb24iOiAiMS4wIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0wNi0xMiJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzAwNjYlMjMwMDAxIiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0wNy0yMCIsICJoYXNoIjogIjlfN0RQclhtamlzWDRQangyaHhRQkdjajQ5aldXRXJCcWJ1YzZpdWlVbzA9IiwgImFhaWQiOiAiMDA2NiMwMDAxIiwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiTk9UX0ZJRE9fQ0VSVElGSUVEIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGUiOiAiIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0wNy0yMCJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzAwNjYlMjMwMDAyIiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0wOC0xNyIsICJoYXNoIjogImNmejAxMWc3WUR0dk1BbUstQ29wYUduSUF5RkRNRUZkZDBFY2U1Qmh6SUE9IiwgImFhaWQiOiAiMDA2NiMwMDAyIiwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiTk9UX0ZJRE9fQ0VSVElGSUVEIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGUiOiAiIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0wOC0xNyJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzA3YTlmODljLTY0MDctNDU5NC05ZDU2LTYyMWQ1ZjFlMzU4YiIsICJ0aW1lT2ZMYXN0U3RhdHVzQ2hhbmdlIjogIjIwMTgtMDctMDQiLCAiYWFndWlkIjogIjA3YTlmODljLTY0MDctNDU5NC05ZDU2LTYyMWQ1ZjFlMzU4YiIsICJoYXNoIjogInNVSUttc2s2VUw2VWdJVGxubjNsak5leUYzRWF5NUlJSlZXclFjY1Y1N1U9IiwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiTk9UX0ZJRE9fQ0VSVElGSUVEIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGUiOiAiIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0wNy0wNCJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzRlNGUlMjM0MDA1IiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0wNS0xOSIsICJoYXNoIjogIml1UnZpTU1uQnJYblZyakkwVGlhY1R6S3FkRzhWWFRBNlBVeTRyN1N4aGs9IiwgImFhaWQiOiAiNGU0ZSM0MDA1IiwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiTk9UX0ZJRE9fQ0VSVElGSUVEIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGUiOiAiIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0wNS0xOSJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzRlNGUlMjM0MDA2IiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0wNS0xOSIsICJoYXNoIjogIjgzVE54NTZTZmE2ZUlXTkNka21PaFRRMTdPUjgtTlVtSlpZbjFTVnVRN009IiwgImFhaWQiOiAiNGU0ZSM0MDA2IiwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiTk9UX0ZJRE9fQ0VSVElGSUVEIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGUiOiAiIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0wNS0xOSJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzRlNGUlMjM0MDA5IiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0wNS0xOSIsICJoYXNoIjogInFRRGRMWG15RHd3QjhCS1ptYlljQXhZMVZOWnRZazRJclhHN211NjRMT2M9IiwgImFhaWQiOiAiNGU0ZSM0MDA5IiwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiTk9UX0ZJRE9fQ0VSVElGSUVEIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGUiOiAiIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0wNS0xOSJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzRlNGUlMjM0MDBhIiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0wNS0xOSIsICJoYXNoIjogIjZUNXNSaVZBOEdTQVNCNFFmdnFfVW9MUF9CYkRVeWhpZW9WNmhVd1kzQ0E9IiwgImFhaWQiOiAiNGU0ZSM0MDBhIiwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiTk9UX0ZJRE9fQ0VSVElGSUVEIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGUiOiAiIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0wNS0xOSJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzRlNGUlMjM0MDBiIiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0wNS0xOSIsICJoYXNoIjogIml5aERUZGJ2Z3NrV3lNa3BJRDhEb1N0cEhzZDZWLWJpOEdVVW1NbXFfRm89IiwgImFhaWQiOiAiNGU0ZSM0MDBiIiwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiTk9UX0ZJRE9fQ0VSVElGSUVEIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGUiOiAiIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0wNS0xOSJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzRlNGUlMjM0MDEwIiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0wNS0xOSIsICJoYXNoIjogIkkwd3NqU0ZYcHRxRXEtY1dVUEtRdGJsRzRJNTh4bFBIeVdNYlVzSE1UWkU9IiwgImFhaWQiOiAiNGU0ZSM0MDEwIiwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiTk9UX0ZJRE9fQ0VSVElGSUVEIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGUiOiAiIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0wNS0xOSJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzRlNGUlMjM0MDExIiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0wNS0xOSIsICJoYXNoIjogIlhVS1dPYTN4VWVXRkdEYnhIVTZhZ0JDNUlXSEdJbURNUlNkWjZlbVdlUDQ9IiwgImFhaWQiOiAiNGU0ZSM0MDExIiwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiTk9UX0ZJRE9fQ0VSVElGSUVEIiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGUiOiAiIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0wNS0xOSJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzc3MDEwYmQ3LTIxMmEtNGZjOS1iMjM2LWQyY2E1ZTlkNDA4NCIsICJ0aW1lT2ZMYXN0U3RhdHVzQ2hhbmdlIjogIjIwMTgtMTAtMjYiLCAiYWFndWlkIjogIjc3MDEwYmQ3LTIxMmEtNGZjOS1iMjM2LWQyY2E1ZTlkNDA4NCIsICJoYXNoIjogIkM1alFudEdtdmlwZlRIUjd0TFp3S19PZEpMaHlwSkd3cDFVSmVWVEpvZ2c9IiwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiRklET19DRVJUSUZJRURfTDEiLCAiY2VydGlmaWNhdGVOdW1iZXIiOiAiRklETzIwMDIwMTgwOTI5MDAxIiwgImNlcnRpZmljYXRlIjogIiIsICJjZXJ0aWZpY2F0aW9uRGVzY3JpcHRvciI6ICJGZWl0aWFuIEJpb1Bhc3MgRklETzIgYXV0aGVudGljYXRvciIsICJ1cmwiOiAiIiwgImNlcnRpZmljYXRpb25SZXF1aXJlbWVudHNWZXJzaW9uIjogIjEuMS4wIiwgImNlcnRpZmljYXRpb25Qb2xpY3lWZXJzaW9uIjogIjEuMy40IiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0xMC0yNiJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhLzlqcmRFa0ZCY3Zja1d6OGc2TmNMcTQiLCAiaGFzaCI6ICJEN3lrd2Q3eEMydm80cExIMlpSOEdMZ2hJSkxxQWxTUDBORVlzV1hBdTBRPSIsICJ0aW1lT2ZMYXN0U3RhdHVzQ2hhbmdlIjogIjIwMTgtMTEtMDEiLCAiYXR0ZXN0YXRpb25DZXJ0aWZpY2F0ZUtleUlkZW50aWZpZXJzIjogWyI0MTgzNzdlMjEzZGIxNGFiYzY1MDlkYjVlMTBjOTU5OGI0MmY5MmVhIl0sICJzdGF0dXNSZXBvcnRzIjogW3sic3RhdHVzIjogIkZJRE9fQ0VSVElGSUVEX0wyIiwgImNlcnRpZmljYXRlTnVtYmVyIjogIlUyRjEwMDAyMDE4MDIyODAwNiIsICJjZXJ0aWZpY2F0ZSI6ICIiLCAiY2VydGlmaWNhdGlvbkRlc2NyaXB0b3IiOiAiTXVsdGlQYXNzIEZJRE8gU2VjdXJpdHkgS2V5IiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGlvblJlcXVpcmVtZW50c1ZlcnNpb24iOiAiMS4wLjEiLCAiY2VydGlmaWNhdGlvblBvbGljeVZlcnNpb24iOiAiMS4wLjEiLCAiZWZmZWN0aXZlRGF0ZSI6ICIyMDE4LTExLTAxIn1dfSwgeyJ1cmwiOiAiaHR0cHM6Ly9tZHMyLmZpZG9hbGxpYW5jZS5vcmcvbWV0YWRhdGEvSjQ2SGRWbUZvbUZDSlJmZHpaZ1lnZSIsICJoYXNoIjogIldocHdVQVUzcWVuazRQU2w5OVV2X09zeHZUOWt0RU5lY1BpU19sUGVkYkk9IiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0xMS0wMSIsICJhdHRlc3RhdGlvbkNlcnRpZmljYXRlS2V5SWRlbnRpZmllcnMiOiBbIjZjZDk5ZDhiMGFiZmE2YTQzNzgxMzhhMTQ3NWY3ZTQ2ZGYyMTdhMjUiLCAiN2E4ZmUzN2E0MmJiZjJhNWIzZTY1NzRkNmYwNGJkYmM1NWU1OTA0NyIsICJjMTBiYzRjNmY2MTRiNjMzNzFkOTI5NTk2ZWRlZGRlM2U0NTg0MDRkIiwgIjc2ZTQ3YjQ3ZTMyODE0YWFhNmE4N2MyODBjZmNiZDUyNzg4MWE0MDQiXSwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiRklET19DRVJUSUZJRURfTDIiLCAiY2VydGlmaWNhdGVOdW1iZXIiOiAiVTJGMTAwMDIwMTgwMjI4MDA3IiwgImNlcnRpZmljYXRlIjogIiIsICJjZXJ0aWZpY2F0aW9uRGVzY3JpcHRvciI6ICJlUGFzcyBGSURPIFNlY3VyaXR5IEtleSIsICJ1cmwiOiAiIiwgImNlcnRpZmljYXRpb25SZXF1aXJlbWVudHNWZXJzaW9uIjogIjEuMS4wIiwgImNlcnRpZmljYXRpb25Qb2xpY3lWZXJzaW9uIjogIjEuMC4xIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0xMS0wMSJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhL0pzcnRiektLNUtCS1doampOUVFjQWMiLCAiaGFzaCI6ICJJd0RDR0UtM2xkVGRJY01kV2pBN2VnZHVWSDFJOGszUGNqUzB6WWkzQmlnPSIsICJ0aW1lT2ZMYXN0U3RhdHVzQ2hhbmdlIjogIjIwMTktMDEtMDciLCAiYXR0ZXN0YXRpb25DZXJ0aWZpY2F0ZUtleUlkZW50aWZpZXJzIjogWyJmZmY5NDBkMzU3OWJjNDQwNDA1NTc0N2IzNjcwZDQzYTFlOTdkMDU0Il0sICJzdGF0dXNSZXBvcnRzIjogW3sic3RhdHVzIjogIkZJRE9fQ0VSVElGSUVEIiwgImNlcnRpZmljYXRlTnVtYmVyIjogIlUyRjEwMDAyMDE1MDgxMTAwMSIsICJjZXJ0aWZpY2F0ZSI6ICIiLCAiY2VydGlmaWNhdGlvbkRlc2NyaXB0b3IiOiAiQmx1aW5rIEx0ZCwgSW5qZWN0b3IsIFUyRiIsICJ1cmwiOiAiIiwgImNlcnRpZmljYXRpb25SZXF1aXJlbWVudHNWZXJzaW9uIjogIjEuMCIsICJjZXJ0aWZpY2F0aW9uUG9saWN5VmVyc2lvbiI6ICIxLjAiLCAiZWZmZWN0aXZlRGF0ZSI6ICIyMDE5LTAxLTA3In1dfSwgeyJ1cmwiOiAiaHR0cHM6Ly9tZHMyLmZpZG9hbGxpYW5jZS5vcmcvbWV0YWRhdGEvS0J6V1hOMzhFZUNwUXA5cUhWQnBTbSIsICJoYXNoIjogIno3cnlrcXdLRXAxQzJRc0h1dXJ1NXlLcE01ZDNkYUJldDJvSWhWdDVkTlk9IiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0xMS0wMSIsICJhdHRlc3RhdGlvbkNlcnRpZmljYXRlS2V5SWRlbnRpZmllcnMiOiBbIjkyMzg4MWZlMmYyMTRlZTQ2NTQ4NDM3MWFlYjcyZTk3ZjVhNThlMGEiXSwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiRklET19DRVJUSUZJRURfTDIiLCAiY2VydGlmaWNhdGVOdW1iZXIiOiAiVTJGMTAwMDIwMTgwMjI4MDA1IiwgImNlcnRpZmljYXRlIjogIiIsICJjZXJ0aWZpY2F0aW9uRGVzY3JpcHRvciI6ICJGZWl0aWFuIEJpb1Bhc3MgRklETyBVMkYgU2VjdXJpdHkgS2V5IiwgInVybCI6ICIiLCAiY2VydGlmaWNhdGlvblJlcXVpcmVtZW50c1ZlcnNpb24iOiAiMS4wLjEiLCAiY2VydGlmaWNhdGlvblBvbGljeVZlcnNpb24iOiAiMS4wLjEiLCAiZWZmZWN0aXZlRGF0ZSI6ICIyMDE4LTExLTAxIn1dfSwgeyJ1cmwiOiAiaHR0cHM6Ly9tZHMyLmZpZG9hbGxpYW5jZS5vcmcvbWV0YWRhdGEvUFZ5Uno2ckJHak1NczVQNU1Ia05WVSIsICJoYXNoIjogIjdpQU1Qb2dqSEhFQW1tQkZ6OHdsVThuMUo2N3BzMUJuR1llOW1Fb19UTHM9IiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0wOS0xNCIsICJhdHRlc3RhdGlvbkNlcnRpZmljYXRlS2V5SWRlbnRpZmllcnMiOiBbImM4ODlhYmQwMTYyN2I5OGQyZjdjMWNkOWQ1ZDE2ZDJkMDI2MmY2OTYiXSwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiRklET19DRVJUSUZJRURfTDEiLCAiY2VydGlmaWNhdGVOdW1iZXIiOiAiVTJGMTAwMDIwMTgwMjIxMDAxIiwgImNlcnRpZmljYXRlIjogIiIsICJjZXJ0aWZpY2F0aW9uRGVzY3JpcHRvciI6ICJVbml2ZXJzYWwgU2Vjb25kIEZhY3RvciAoVTJGKSIsICJ1cmwiOiAiIiwgImNlcnRpZmljYXRpb25SZXF1aXJlbWVudHNWZXJzaW9uIjogIjEuMCIsICJjZXJ0aWZpY2F0aW9uUG9saWN5VmVyc2lvbiI6ICIxLjMuMiIsICJlZmZlY3RpdmVEYXRlIjogIjIwMTgtMDktMTQifV19LCB7InVybCI6ICJodHRwczovL21kczIuZmlkb2FsbGlhbmNlLm9yZy9tZXRhZGF0YS9SRTM2NlQ0cUtESzRudmdCNFg1M2FVIiwgImhhc2giOiAiQVpSWFNaLVRKU0s4MlVzcDRiY2hycEc4dzlfcy1uRVZSM2ZEUW9DdGhWYz0iLCAidGltZU9mTGFzdFN0YXR1c0NoYW5nZSI6ICIyMDE4LTEwLTExIiwgImF0dGVzdGF0aW9uQ2VydGlmaWNhdGVLZXlJZGVudGlmaWVycyI6IFsiM2MyMmI1OTdmMzBlODY4OWVkMjQ2MGY5ZGZlOTliNzUxMDMyOTJmNiJdLCAic3RhdHVzUmVwb3J0cyI6IFt7InN0YXR1cyI6ICJOT1RfRklET19DRVJUSUZJRUQiLCAidXJsIjogIiIsICJjZXJ0aWZpY2F0ZSI6ICIiLCAiZWZmZWN0aXZlRGF0ZSI6ICIyMDE4LTEwLTExIn1dfSwgeyJ1cmwiOiAiaHR0cHM6Ly9tZHMyLmZpZG9hbGxpYW5jZS5vcmcvbWV0YWRhdGEvZWUwNDFiY2UtMjVlNS00Y2RiLThmODYtODk3ZmQ2NDE4NDY0IiwgInRpbWVPZkxhc3RTdGF0dXNDaGFuZ2UiOiAiMjAxOC0xMC0yNiIsICJhYWd1aWQiOiAiZWUwNDFiY2UtMjVlNS00Y2RiLThmODYtODk3ZmQ2NDE4NDY0IiwgImhhc2giOiAiSExmN0V3dVM2MmFPTmY5MU9WYm5KQ19KenhjNnlnczU3RURqdW5ielVsWT0iLCAic3RhdHVzUmVwb3J0cyI6IFt7InN0YXR1cyI6ICJGSURPX0NFUlRJRklFRF9MMSIsICJjZXJ0aWZpY2F0ZU51bWJlciI6ICJGSURPMjAwMjAxODA5MjkwMDIiLCAiY2VydGlmaWNhdGUiOiAiIiwgImNlcnRpZmljYXRpb25EZXNjcmlwdG9yIjogIkZlaXRpYW4gZVBhc3MgRklETzItTkZDIEF1dGhlbnRpY2F0b3IiLCAidXJsIjogIiIsICJjZXJ0aWZpY2F0aW9uUmVxdWlyZW1lbnRzVmVyc2lvbiI6ICIxLjEuMCIsICJjZXJ0aWZpY2F0aW9uUG9saWN5VmVyc2lvbiI6ICIxLjMuNCIsICJlZmZlY3RpdmVEYXRlIjogIjIwMTgtMTAtMjYifV19LCB7InVybCI6ICJodHRwczovL21kczIuZmlkb2FsbGlhbmNlLm9yZy9tZXRhZGF0YS90M2Z5WGpBaDJFdTdFRHNONHRRNkhMIiwgImhhc2giOiAiSklmcHlnU0ZsNVBiVXF4SG9QVnpHbElNMEVfd2JVQVZ2Rk1TQ2ZrOE9GUT0iLCAidGltZU9mTGFzdFN0YXR1c0NoYW5nZSI6ICIyMDE4LTExLTA4IiwgImF0dGVzdGF0aW9uQ2VydGlmaWNhdGVLZXlJZGVudGlmaWVycyI6IFsiZDVkYjRkZDQ4ZmU0NmFmZDhhZjhmMWY3Y2ZiZGVlNjE2NDBiYmJjYyIsICI1NTQ2NGQ1YmVhODRlNzA3MzA3NGIyMWQxMjA0OTM0MzU4YzdkYjRkIiwgImY0YjY0YTY4YzMzNGU5MDFiOGUyM2M2ZTY2ZTY4NjZjMzE5MzFmNWQiXSwgInN0YXR1c1JlcG9ydHMiOiBbeyJzdGF0dXMiOiAiRklET19DRVJUSUZJRUQiLCAiY2VydGlmaWNhdGVOdW1iZXIiOiAiVTJGMTAwMDIwMTUxMjIxMDAxIiwgImNlcnRpZmljYXRlIjogIiIsICJjZXJ0aWZpY2F0aW9uRGVzY3JpcHRvciI6ICJGZWl0aWFuIGVQYXNzIEZJRE8tTkZDIFNlY3VyaXR5IEtleSIsICJ1cmwiOiAiIiwgImNlcnRpZmljYXRpb25SZXF1aXJlbWVudHNWZXJzaW9uIjogIjEuMC4xIiwgImNlcnRpZmljYXRpb25Qb2xpY3lWZXJzaW9uIjogIjEuMC4xIiwgImVmZmVjdGl2ZURhdGUiOiAiMjAxOC0xMS0wOCJ9XX0sIHsidXJsIjogImh0dHBzOi8vbWRzMi5maWRvYWxsaWFuY2Uub3JnL21ldGFkYXRhL3hobmtxYkYzc3ZEdUt0S0xyd1Jqc00iLCAiaGFzaCI6ICJ1bWNxSjFZdHJNSHRTcmRWSGVGZVBfM0hDTXdOZUZBY1ZZSjNDZXV3SFhRPSIsICJ0aW1lT2ZMYXN0U3RhdHVzQ2hhbmdlIjogIjIwMTktMDEtMDciLCAiYXR0ZXN0YXRpb25DZXJ0aWZpY2F0ZUtleUlkZW50aWZpZXJzIjogWyI1NTZkMjdmMzhiMjMxYmIzZDgxOGJmYzFiNjE1ZjI2MGY2YjA4ZjIwIl0sICJzdGF0dXNSZXBvcnRzIjogW3sic3RhdHVzIjogIkZJRE9fQ0VSVElGSUVEIiwgImNlcnRpZmljYXRlTnVtYmVyIjogIlUyRjExMDAyMDE4MDcwOTAwMSIsICJjZXJ0aWZpY2F0ZSI6ICIiLCAiY2VydGlmaWNhdGlvbkRlc2NyaXB0b3IiOiAiVTJGIEF1dGhlbnRpY2F0b3IiLCAidXJsIjogIm1rLmNvbS52biIsICJjZXJ0aWZpY2F0aW9uUmVxdWlyZW1lbnRzVmVyc2lvbiI6ICIxLjEiLCAiY2VydGlmaWNhdGlvblBvbGljeVZlcnNpb24iOiAiMS4zLjMiLCAiZWZmZWN0aXZlRGF0ZSI6ICIyMDE5LTAxLTA3In1dfV0sICJubyI6IDExLCAibGVnYWxIZWFkZXIiOiAiTWV0YWRhdGEgTGVnYWwgSGVhZGVyOiBWZXJzaW9uIDEuMDAuXHUzMDAwRGF0ZTogTWF5IDIxLCAyMDE4LiAgVG8gYWNjZXNzLCB2aWV3IGFuZCB1c2UgYW55IE1ldGFkYXRhIFN0YXRlbWVudHMgb3IgdGhlIFRPQyBmaWxlIChcdTIwMWNNRVRBREFUQVx1MjAxZCkgZnJvbSB0aGUgTURTLCBZb3UgbXVzdCBiZSBib3VuZCBieSB0aGUgbGF0ZXN0IEZJRE8gQWxsaWFuY2UgTWV0YWRhdGEgVXNhZ2UgVGVybXMgdGhhdCBjYW4gYmUgZm91bmQgYXQgaHR0cDovL21kczIuZmlkb2FsbGlhbmNlLm9yZy8gLiBJZiB5b3UgYWxyZWFkeSBoYXZlIGEgdmFsaWQgdG9rZW4sIGFjY2VzcyB0aGUgYWJvdmUgVVJMIGF0dGFjaGluZyB5b3VyIHRva2VuIHN1Y2ggYXMgaHR0cDovL21kczIuZmlkb2FsbGlhbmNlLm9yZz90b2tlbj1ZT1VSLVZBTElELVRPS0VOLiAgSWYgWW91IGhhdmUgbm90IGVudGVyZWQgaW50byB0aGUgYWdyZWVtZW50LCBwbGVhc2UgdmlzaXQgdGhlIHJlZ2lzdHJhdGlvbiBzaXRlIGZvdW5kIGF0IGh0dHA6Ly9maWRvYWxsaWFuY2Uub3JnL01EUy8gYW5kIGVudGVyIGludG8gdGhlIGFncmVlbWVudCBhbmQgb2J0YWluIGEgdmFsaWQgdG9rZW4uICBZb3UgbXVzdCBub3QgcmVkaXN0cmlidXRlIHRoaXMgZmlsZSB0byBhbnkgdGhpcmQgcGFydHkuIFJlbW92YWwgb2YgdGhpcyBMZWdhbCBIZWFkZXIgb3IgbW9kaWZ5aW5nIGFueSBwYXJ0IG9mIHRoaXMgZmlsZSByZW5kZXJzIHRoaXMgZmlsZSBpbnZhbGlkLiAgVGhlIGludGVncml0eSBvZiB0aGlzIGZpbGUgYXMgb3JpZ2luYWxseSBwcm92aWRlZCBmcm9tIHRoZSBNRFMgaXMgdmFsaWRhdGVkIGJ5IHRoZSBoYXNoIHZhbHVlIG9mIHRoaXMgZmlsZSB0aGF0IGlzIHJlY29yZGVkIGluIHRoZSBNRFMuIFRoZSB1c2Ugb2YgaW52YWxpZCBmaWxlcyBpcyBzdHJpY3RseSBwcm9oaWJpdGVkLiBJZiB0aGUgdmVyc2lvbiBudW1iZXIgZm9yIHRoZSBMZWdhbCBIZWFkZXIgaXMgdXBkYXRlZCBmcm9tIFZlcnNpb24gMS4wMCwgdGhlIE1FVEFEQVRBIGJlbG93IG1heSBhbHNvIGJlIHVwZGF0ZWQgb3IgbWF5IG5vdCBiZSBhdmFpbGFibGUuIFBsZWFzZSB1c2UgdGhlIE1FVEFEQVRBIHdpdGggdGhlIExlZ2FsIEhlYWRlciB3aXRoIHRoZSBsYXRlc3QgdmVyc2lvbiBudW1iZXIuICBEYXRlZDogMjAxOC0wNS0yMSBWZXJzaW9uIExILTEuMDAifQ.87kNV5Zr3ccpmiEEjj1pEfJx2U6KCSs4fZYB3E5BJpjYshKUlTDm2OPDrWL6XDsadczpBUVsT-x5A7bgfrkNBw";
        when(fidoMDSClient.fetchMetadataTOC()).thenReturn(toc);
    }

    @Test
    public void needsRefresh_test_with_cache_null() {
        target.cachedMetadataMap = null;
        assertThat(target.needsRefresh()).isTrue();
    }

    @Test
    public void needsRefresh_test_with_future_nextUpdate() {
        target.cachedMetadataMap = new HashMap<>();
        target.nextUpdate = now.plusDays(1);
        target.lastRefresh = now.minusWeeks(1);

        assertThat(target.needsRefresh()).isFalse();
    }

    @Test
    public void needsRefresh_test_with_equal_nextUpdate_and_lastRefresh_within_one_hour() {
        target.cachedMetadataMap = new HashMap<>();
        target.nextUpdate = now;
        target.lastRefresh = now.minusMinutes(59);

        assertThat(target.needsRefresh()).isFalse();
    }

    @Test
    public void needsRefresh_test_with_past_nextUpdate() {
        target.cachedMetadataMap = new HashMap<>();
        target.nextUpdate = now.minusDays(1);
        target.lastRefresh = now.minusWeeks(1);

        assertThat(target.needsRefresh()).isTrue();
    }

    @Test
    public void fetchMetadataTOCPayload_test(){
        target.fetchMetadataTOCPayload();
    }
}
